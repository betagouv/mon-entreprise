secteur:
  question: De quel secteur relève votre activité principale ?
  une possibilité:
    choix obligatoire: oui
    possibilités: [S1, S1bis, S2]
  metadata:
    component: ToggleRadioBlock

secteur . S1:
  valeur: secteur = 'S1'
  titre: Secteur dit S1
  description: Activités du tourisme, de l’hôtellerie, de la restauration, du sport, de la culture, du transport aérien et de l’événementiel

secteur . S1bis:
  valeur: secteur = 'S1bis'
  titre: Secteur dit S1bis
  description: Activités dépendantes du secteur 1

secteur . S2:
  valeur: secteur = 'S2'
  titre: Secteur dit S2
  description: Autres activités ayant fait l'objet d'une interdiction (par exemple, commerces)

secteur . S1 ou S1bis:
  une de ces conditions:
    - S1
    - S1bis

lieu d'exercice:
  question: Où exercez-vous votre activité ?
  une possibilité:
    choix obligatoire: oui
    possibilités:
      - métropole
      - outre-mer

lieu d'exercice . métropole:
  titre: En métropole
lieu d'exercice . outre-mer:
  titre: En outre-mer

début d'activité:
  titre: Période de début d’activité
  question: À quelle période avez-vous débuté votre activité ?
  formulaire:
    type: select
  une possibilité:
    choix obligatoire: oui
    possibilités:
      - avant 2021
      - janvier 2021
      - février 2021
      - mars 2021
      - avril 2021
      - mai 2021
      - juin 2021
      - juillet 2021
      - août 2021
      - septembre 2021
      - octobre 2021
      - novembre 2021
      - décembre 2021

début d'activité . avant 2021:
début d'activité . janvier 2021:
début d'activité . février 2021:
début d'activité . mars 2021:
début d'activité . avril 2021:
début d'activité . mai 2021:
début d'activité . juin 2021:
début d'activité . juillet 2021:
début d'activité . août 2021:
début d'activité . septembre 2021:
début d'activité . octobre 2021:
début d'activité . novembre 2021:
début d'activité . décembre 2021:

début d'activité . date:
  # Converti les possibilités en date (dans le futur on aimerait avoir des select basé sur des types sommes, et un type pour exprimer un 'mois' d'une date)
  variations:
    - si: début d'activité = 'avant 2021'
      alors: 12/2020
    - si: début d'activité = 'janvier 2021'
      alors: 01/2021
    - si: début d'activité = 'février 2021'
      alors: 02/2021
    - si: début d'activité = 'mars 2021'
      alors: 03/2021
    - si: début d'activité = 'avril 2021'
      alors: 04/2021
    - si: début d'activité = 'mai 2021'
      alors: 05/2021
    - si: début d'activité = 'juin 2021'
      alors: 06/2021
    - si: début d'activité = 'juillet 2021'
      alors: 07/2021
    - si: début d'activité = 'août 2021'
      alors: 08/2021
    - si: début d'activité = 'septembre 2021'
      alors: 09/2021
    - si: début d'activité = 'octobre 2021'
      alors: 10/2021
    - si: début d'activité = 'novembre 2021'
      alors: 11/2021
    - si: début d'activité = 'décembre 2021'
      alors: 12/2021

mois:
  applicable si: secteur . S1 ou S1bis
  valeur: oui

mois . janvier 2021:
  applicable si: début d'activité . date >= 01/2021
  non applicable si: début d'activité . date >= 02/2021
  une possibilité:
    possibilités:
      - LFSS 600

mois . janvier 2021 . LFSS 600:
  valeur: janvier 2021 = 'LFSS 600'

mois . février 2021:
  non applicable si: début d'activité . date >= 03/2021
  applicable si: début d'activité . date >= 01/2021
  une possibilité:
    possibilités:
      - LFSS 600

mois . février 2021 . LFSS 600:
  valeur: février 2021 = 'LFSS 600'

mois . mars 2021:
  non applicable si: début d'activité . date >= 04/2021
  applicable si: début d'activité . date >= 01/2021
  une possibilité:
    possibilités:
      - LFSS 600

mois . mars 2021 . LFSS 600:
  valeur: mars 2021 = 'LFSS 600'

mois . avril 2021:
  non applicable si: début d'activité . date >= 05/2021
  une possibilité:
    possibilités:
      - LFSS 600

mois . avril 2021 . LFSS 600:
  valeur: avril 2021 = 'LFSS 600'

mois . mai 2021:
  non applicable si: début d'activité . date >= 06/2021
  une possibilité:
    possibilités:
      - LFSS 600

mois . mai 2021 . LFSS 600:
  valeur: mai 2021 = 'LFSS 600'

mois . juin 2021:
  non applicable si: début d'activité . date >= 07/2021
  une possibilité:
    possibilités:
      - LFSS 600
      - LFR1

mois . juin 2021 . LFSS 600:
  valeur: juin 2021 = 'LFSS 600'
mois . juin 2021 . LFR1:
  applicable si: LFR1 applicable
  valeur: juin 2021 = 'LFR1'

mois . juillet 2021:
  non applicable si: début d'activité . date >= 08/2021
  une possibilité:
    possibilités:
      - LFSS 600
      - LFR1

mois . juillet 2021 . LFSS 600:
  valeur: juillet 2021 = 'LFSS 600'

mois . juillet 2021 . LFR1:
  applicable si: LFR1 applicable
  valeur: juillet 2021 = 'LFR1'

mois . août 2021:
  non applicable si: début d'activité . date >= 09/2021
  applicable si:
    une de ces conditions:
      - LFR1 applicable
      - lieu d'exercice = 'outre-mer'
  une possibilité:
    possibilités:
      - LFSS 600
      - LFR1

mois . août 2021 . LFSS 600:
  valeur: août 2021 = 'LFSS 600'
  applicable si: lieu d'exercice = 'outre-mer'

mois . août 2021 . LFR1:
  applicable si: LFR1 applicable
  valeur: août 2021 = 'LFR1'

mois . septembre 2021:
  non applicable si: début d'activité . date >= 10/2021
  applicable si: lieu d'exercice = 'outre-mer'
  une possibilité:
    possibilités:
      - LFSS 600

mois . septembre 2021 . LFSS 600:
  valeur: septembre 2021 = 'LFSS 600'

mois . octobre 2021:
  non applicable si: début d'activité . date >= 11/2021
  applicable si: lieu d'exercice = 'outre-mer'
  une possibilité:
    possibilités:
      - LFSS 600

mois . octobre 2021 . LFSS 600:
  valeur: octobre 2021 = 'LFSS 600'

mois . novembre 2021:
  non applicable si: début d'activité . date >= 12/2021
  applicable si: lieu d'exercice = 'outre-mer'
  une possibilité:
    possibilités:
      - LFSS 600

mois . novembre 2021 . LFSS 600:
  valeur: novembre 2021 = 'LFSS 600'

mois . décembre 2021:
  une possibilité:
    possibilités:
      - LFSS 600
      - LFSS 300

mois . décembre 2021 . LFSS 600:
  valeur: décembre 2021 = 'LFSS 600'
mois . décembre 2021 . LFSS 300:
  valeur: décembre 2021 = 'LFSS 300'

mois . janvier 2022:
  une possibilité:
    possibilités:
      - LFSS 600
      - LFSS 300

mois . janvier 2022 . LFSS 600:
  valeur: janvier 2022 = 'LFSS 600'
mois . janvier 2022 . LFSS 300:
  valeur: janvier 2022 = 'LFSS 300'

mois . février 2022:
  une possibilité:
    possibilités:
      - LFSS 600
      - LFSS 300

mois . février 2022 . LFSS 600:
  valeur: février 2022 = 'LFSS 600'
mois . février 2022 . LFSS 300:
  valeur: février 2022 = 'LFSS 300'

LFSS 600:
  applicable si: secteur . S1 ou S1bis
  produit:
    assiette: 600 €/mois
    facteur:
      nom: mois éligibles
      unité: mois
      description: Nombre de mois éligible à l'exonération LFSS à 600 €
      somme:
        - valeur: mois . janvier 2021 . LFSS 600
          par défaut: non
        - valeur: mois . février 2021 . LFSS 600
          par défaut: non
        - valeur: mois . mars 2021 . LFSS 600
          par défaut: non
        - valeur: mois . avril 2021 . LFSS 600
          par défaut: non
        - valeur: mois . mai 2021 . LFSS 600
          par défaut: non
        - valeur: mois . juin 2021 . LFSS 600
          par défaut: non
        - valeur: mois . juillet 2021 . LFSS 600
          par défaut: non
        - valeur: mois . août 2021 . LFSS 600
          par défaut: non
        - valeur: mois . septembre 2021 . LFSS 600
          par défaut: non
        - valeur: mois . octobre 2021 . LFSS 600
          par défaut: non
        - valeur: mois . novembre 2021 . LFSS 600
          par défaut: non
        - valeur: mois . décembre 2021 . LFSS 600
          par défaut: non
        - valeur: mois . janvier 2022 . LFSS 600
          par défaut: non
        - valeur: mois . février 2022 . LFSS 600
          par défaut: non

LFSS 300:
  applicable si: secteur . S1 ou S1bis
  produit:
    assiette: 300 €/mois
    facteur:
      nom: mois éligibles
      description: Nombre de mois éligible à l'exonération LFSS à 300€
      unité: mois
      somme:
        - valeur: mois . décembre 2021 . LFSS 300
          par défaut: non
        - valeur: mois . janvier 2022 . LFSS 300
          par défaut: non
        - valeur: mois . février 2022 . LFSS 300
          par défaut: non

LFR1 applicable:
  valeur: oui
  applicable si:
    toutes ces conditions:
      - secteur . S1 ou S1bis
      - début d'activité . date < 06/2021
  non applicable si:
    toutes ces conditions:
      - début d'activité . date >= 01/2021
      - mois . mars 2021 . LFSS 600 = non
      - mois . avril 2021 . LFSS 600 = non
      - mois . mai 2021 . LFSS 600 = non

LFR1:
  produit:
    assiette: 250 €/mois
    facteur:
      unité: mois
      description: Nombre de mois éligible à l'exonération LFR1
      nom: mois éligibles
      somme:
        - valeur: mois . juin 2021 . LFR1
          par défaut: non
        - valeur: mois . juillet 2021 . LFR1
          par défaut: non
        - valeur: mois . août 2021 . LFR1
          par défaut: non

exonération S2:
  produit:
    assiette: 600 €/mois
    facteur: mois éligibles
  applicable si:
    toutes ces conditions:
      - secteur . S2
      - début d'activité . date <= mois éligibles . dernier mois

exonération S2 . mois éligibles:
  unité: mois
  arrondi: oui
  question:
    texte: Précisez le nombre de mois entre {{ premier mois }} et {{ dernier mois }} durant lesquels vous avez fait l’objet d’une mesure d’interdiction affectant de manière prépondérante la poursuite de votre activité
  plafond:
    nom: plafond
    somme:
      - durée:
          depuis: premier mois
          jusqu'à: dernier mois
        arrondi: oui
        unité: mois
      - 1 mois

exonération S2 . mois éligibles . premier mois:
  variations:
    - si: début d'activité . date < 01/2021
      alors: 04/2021
    - sinon:
        valeur: début d'activité . date
        plancher: 02/2021
        plafond: dernier mois

exonération S2 . mois éligibles . dernier mois:
  variations:
    - si: lieu d'exercice = 'outre-mer'
      alors: 09/2021
    - sinon: 07/2021

montant total:
  somme:
    - LFSS 600
    - LFR1
    - LFSS 300
    - exonération S2

code:
  texte: '{{ secteur }};{{ LFSS }};{{ LFR1 }}'

  # Applicabilité ajoutée pour éviter un code mal formatté en cas de variable non définie
  # Cf https://github.com/betagouv/publicodes/issues/172
  applicable si:
    toutes ces conditions:
      - secteur
      - LFSS
      - LFR1

code . secteur:
  variations:
    - si: secteur . S1bis
      alors: "'S1B'"
    - sinon: secteur

code . LFSS:
  variations:
    - si: secteur . S2
      alors:
        texte: O;{{ mois S2 }}
    - si: LFSS 300 + LFSS 600 = 0€
      alors: "'N'"
    - si: LFSS 300 = 0€
      alors:
        texte: O;{{ mois 600 }}
    - sinon: # LFSS 300 et 600
        texte: O;{{ mois 600 }};{{ mois 300}}

code . LFSS . mois S2:
  valeur: exonération S2 . mois éligibles
  unité: ''
code . LFSS . mois 300:
  valeur: LFSS 300 . mois éligibles
  unité: ''
code . LFSS . mois 600:
  valeur: LFSS 600 . mois éligibles
  unité: ''

code . LFR1:
  variations:
    - si: LFR1 = 0€
      alors: "'N'"
    - sinon:
        texte: O;{{ mois }}
code . LFR1 . mois:
  valeur: LFR1 . mois éligibles
  unité: ''
