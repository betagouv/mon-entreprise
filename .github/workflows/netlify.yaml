name: DÃ©ploiement sur Netlify
on:
  pull_request:
    types: [opened, synchronize]
env:
  GITHUB_API_SECRET: ${{ secrets.GITHUB_TOKEN }}
  INSEE_SIRENE_API_SECRET: ${{ secrets.INSEE_SIRENE_API_TOKEN }}
  MATOMO_TOKEN: ${{ secrets.MATOMO_TOKEN }}
  # Env names imported from the Netlify CI
  # https://docs.netlify.com/configure-builds/environment-variables/#build-metadata
  HEAD: ${GITHUB_REF#refs/heads/}
  COMMIT_REF: ${GITHUB_SHA}
jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: '12'
      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}
      - run: npm install yarn
      - run: yarn install
      - run: yarn workspace mon-entreprise build
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v1.1
        with:
          publish-dir: './mon-entreprise/dist'
          netlify-config-path: ./netlify.toml
          production-branch: master
          github-token: ${{ secrets.GITHUB_TOKEN }}
          enable-commit-comment: false
          alias: deploy-preview-${{ github.event.number }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 1
